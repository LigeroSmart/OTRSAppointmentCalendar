# --
# Copyright (C) 2001-2016 OTRS AG, http://otrs.com/
# --
# This software comes with ABSOLUTELY NO WARRANTY. For details, see
# the enclosed file COPYING for license information (AGPL). If you
# did not receive this file, see http://www.gnu.org/licenses/agpl.txt.
# --

[% RenderBlockStart("AJAX") %]
<div class="InnerContent">
    <form action="[% Env("CGIHandle") %]" method="post" id="EditAppointmentForm">
        <input type="hidden" name="Action" value="[% Env("Action") %]" id="AgentAppointmentEdit"/>
        <input type="hidden" name="Subaction" value="Store"/>
        <input type="hidden" name="AppointmentID" value="[% Data.AppointmentID | html %]"/>
        <fieldset class="TableLike">
            <legend><span>[% Translate("Basic info") | html %]</span></legend>
            <label>[% Translate("Title") | html %]:</label>
            <div class="Field">
                <input type="text" name="Title" value="[% Data.Title | html %]" class="W95pc" />
            </div>
            <div class="Clear"></div>
            <label>[% Translate("Description") | html %]:</label>
            <div class="Field">
                <textarea name="Description" class="W95pc">[% Data.Description | html %]</textarea>
            </div>
            <div class="Clear"></div>
            <label>[% Translate("Location") | html %]:</label>
            <div class="Field">
                <input type="text" name="Location" value="[% Data.Location | html %]" class="W95pc" />
            </div>
        </fieldset>
        <fieldset class="TableLike">
            <legend><span>[% Translate("Date/Time") | html %]</span></legend>
            <label>[% Translate("Start date") | html %]:</label>
            <div class="Field">
                [% Data.StartDateString %]
            </div>
            <div class="Clear"></div>
            <label>[% Translate("End date") | html %]:</label>
            <div class="Field">
                [% Data.EndDateString %]
            </div>
        </fieldset>
    </form>
</div>

<div class="ContentFooter Center">
    <button id="EditFormSubmit" class="Primary CallForAction" value="Store"><span><i class="fa fa-check-square-o"></i> [% Translate("Save") | html %]</span></button>
    <button id="EditFormCancel" class="CallForAction"><span>[% Translate("Cancel") | html %]</span></button>
</div>

<script type="text/javascript">//<![CDATA[

// Initialize appointment ID
var $AppointmentID = $('input[name="AppointmentID"]'),
    AppointmentID = $AppointmentID.val(),
    CalEvent = null;

if (AppointmentID == '') {

    // Generate an ID
    // TODO: proper callback with stored ID
    AppointmentID = Core.UI.GetID($AppointmentID);
    $AppointmentID.val(AppointmentID);
} else {

    // Try to find the existing event with the same ID
    if ($('#calendar').fullCalendar('clientEvents', AppointmentID).length > 0) {
        CalEvent = $('#calendar').fullCalendar('clientEvents', AppointmentID)[0];
    }
}

// Bind button actions
$('#EditFormSubmit').bind('click', function() {

    // Edit screen
    if (CalEvent) {
        CalEvent.title = $('input[name="Title"]').val();
        CalEvent.Description = $('textarea[name="Description"]').val();
        CalEvent.Location = $('input[name="Location"]').val();
        CalEvent.start = $.fullCalendar.moment()
            .year(parseInt($('#StartYear').val(), 10))
            .month(parseInt($('#StartMonth').val(), 10) - 1)
            .date(parseInt($('#StartDay').val(), 10))
            .hour(parseInt($('#StartHour').val(), 10))
            .minute(parseInt($('#StartMinute').val(), 10));
        CalEvent.end = $.fullCalendar.moment()
            .year(parseInt($('#EndYear').val(), 10))
            .month(parseInt($('#EndMonth').val(), 10) - 1)
            .date(parseInt($('#EndDay').val(), 10))
            .hour(parseInt($('#EndHour').val(), 10))
            .minute(parseInt($('#EndMinute').val(), 10));
        $('#calendar').fullCalendar('updateEvent', CalEvent);
    }

    // Add screen
    else {
        $('#calendar').fullCalendar('renderEvent',
            {
                id: $AppointmentID.val(),
                title: $('input[name="Title"]').val(),
                Description: $('textarea[name="Description"]').val(),
                Location: $('input[name="Location"]').val(),
                start: $.fullCalendar.moment()
                    .year(parseInt($('#StartYear').val(), 10))
                    .month(parseInt($('#StartMonth').val(), 10) - 1)
                    .date(parseInt($('#StartDay').val(), 10))
                    .hour(parseInt($('#StartHour').val(), 10))
                    .minute(parseInt($('#StartMinute').val(), 10)),
                end: $.fullCalendar.moment()
                    .year(parseInt($('#EndYear').val(), 10))
                    .month(parseInt($('#EndMonth').val(), 10) - 1)
                    .date(parseInt($('#EndDay').val(), 10))
                    .hour(parseInt($('#EndHour').val(), 10))
                    .minute(parseInt($('#EndMinute').val(), 10)),
            },
            true
        );
    }

    // Close the dialog
    Core.UI.Dialog.CloseDialog($('.Dialog:visible'));
});

// Close the dialog
$('#EditFormCancel').bind('click', function() {
    Core.UI.Dialog.CloseDialog($('.Dialog:visible'));
});

//]]></script>
[% RenderBlockEnd("AJAX") %]
